<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:t="http://myfaces.apache.org/tomahawk"
                xmlns:tr="http://myfaces.apache.org/trinidad"
                xmlns:trh="http://myfaces.apache.org/trinidad/html"
                xmlns:c="http://java.sun.com/jstl/core"
                xmlns:psv="http://psicquic.mi.psi.hupo.org/view"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:ebi="http://ebi.ac.uk/faces/components"
                xmlns:ebisf="http://www.ebi.ac.uk/faces/site">

<tr:form id="mainForm" inlineStyle="padding: 10px; background-color: white">

<tr:panelGroupLayout layout="vertical">

<!-- To avoid expired sessions, poll every 15 mins -->
<tr:poll id="expiredSessions" interval="#{15*60*1000}"/>

<tr:statusIndicator id="status">
    <f:facet name="busy">
        <tr:panelGroupLayout layout="horizontal">
            <tr:image source="images/status_busy_redback.gif"
                      inlineStyle="vertical-align:middle"/>
            <tr:outputFormatted value="&#160;"/>
            <tr:outputText value="Loading..."/>
        </tr:panelGroupLayout>
    </f:facet>
</tr:statusIndicator>

<tr:panelGroupLayout>
    <tr:messages id="globalErrorMsg"/>
</tr:panelGroupLayout>

<tr:panelGroupLayout rendered="#{not clusteringBean.clusterSelected}">

<ui:include src="/pages/search/search_panel.xhtml"/>

<table style="width:100%">
    <tr style="width:100%">
        <td style="vertical-align: top">
            <tr:spacer height="16px"/>
            Some clues to start:
            <ul>
                <li>Use the check boxes to include or exclude services from the search and cluster operations.
                    <h:panelGroup>
                        <tr:outputText
                                value=" Select: "/>
                        <tr:commandLink id="selectAllLink" text="All"
                                        onclick="psicquic_selectAll(#{fn:length(servicesTable.services)})"
                                />
                        <tr:outputText value=", "/>
                        <tr:commandLink id="selectNoneLink" text="None"
                                        onclick="psicquic_selectNone(#{fn:length(servicesTable.services)})"/>
                    </h:panelGroup>
                </li>
                <li>The numbers show the interactions retrieved in the last query.</li>
                <li>Click on the links below to display the results for each selected service.</li>
                <li>The cluster will be enabled with less than #{config.clusteringSizeLimit} interactions.</li>

            </ul>
        </td>
        <td style="width: 16%;vertical-align: middle; text-align: left">
            <tr:panelBox background="light" text="Status of the service">
                <ui:include src="search/legend.xhtml"/>
            </tr:panelBox>

        </td>
    </tr>
</table>


<table style="width:100%; height: 200px">
    <!--<table>-->
    <tr style="width:100%">
        <td style="vertical-align: top;">
            <!--Services-->

            <tr:panelHorizontalLayout rendered="#{searchBean.totalResults == 0}">
                <!--TODO-->
                <h:outputText style="color: red; font-weight: bold"
                              value="No results were found for this query#{servicesTable.selectedServicesCount lt servicesTable.activeServicesCount ? ' for the selected services' : ''}."
                              rendered="#{servicesTable.selectedServicesCount != 0}"/>
                <h:outputText style="color: red; font-weight: bold"
                              value="Select at least one service from the list below!"
                              rendered="#{servicesTable.selectedServicesCount == 0}"/>
            </tr:panelHorizontalLayout>

            <tr:spacer height="16px"/>
            <tr:panelGroupLayout layout="vertical">

                <tr:group>
                    <tr:outputText id="resultsMsg" value="The query "/>
                    <tr:outputText value="[#{userQuery.searchQuery}]" inlineStyle="font-weight: bold;"/>
                    <tr:outputText value=" contains a total of "/>
                    <tr:outputText id="totalResults" value="#{searchBean.totalResults}"
                                   inlineStyle="font-weight: bold;">
                        <tr:convertNumber pattern="#,###"/>
                    </tr:outputText>
                    <tr:outputText value=" binary interactions."/>
                </tr:group>
                <tr:spacer height="10px"/>
            </tr:panelGroupLayout>

            <tr:spacer height="4px"/>
            <tr:panelFormLayout id="servicesTable" rows="#{config.serviceRows}" maxColumns="4">
                <c:forEach var="service" items="${servicesTable.services}" varStatus="status">
                    <tr:panelHorizontalLayout>

                        <tr:panelPopup id="servicePopUp_${status.index}" triggerType="hover" position="relative"
                                       icon="/images/magnify.png">
                            <tr:outputText value="Service content: "/>
                            <tr:panelList listStyle="list-style-type:square">
                                <c:forEach var="tag" items="${service.tags}" >
                                    <h:outputText value="#{psv:cvTermToName(tag)}"/>
                                </c:forEach>

                            </tr:panelList>
                        </tr:panelPopup>

                        <h:graphicImage id="serviceStatusOff_${status.index}"
                                        alt="Status: OFFLINE" title="Status: OFFLINE"
                                        url="/images/greyLight.png"
                                        width="15px"
                                        rendered="#{not service.active}"/>
                        <h:graphicImage id="serviceStatusOn_${status.index}"
                                        alt="Status: ONLINE" title="Status: ONLINE"
                                        url="/images/greenLight.png"
                                        width="15px"
                                        rendered="#{service.active and not (service.hits lt 0)}"/>
                        <h:graphicImage id="serviceStatusWarn_${status.index}"
                                        alt="Status: WARNING"
                                        title="Status: WARNING - This service can not respond to the query"
                                        url="/images/orangeLight.png"
                                        width="15px"
                                        rendered="#{service.active and (service.hits == -1)}"/>
                        <h:graphicImage id="serviceStatusErr_${status.index}"
                                        alt="Status: ERROR"
                                        title="Status: ERROR - This service has an unexpected error"
                                        url="/images/redLight.png"
                                        width="15px"
                                        rendered="#{service.active and (service.hits == -2)}"/>


                        <h:selectBooleanCheckbox id="serviceSel_${status.index}"
                                                 value="#{service.checked}"
                                                 disabled="#{not service.active}"
                                                 immediate="true"
                                                 onclick="submit()"/>

                        <h:commandLink id="serviceLink_${status.index}" value="#{service.name}"
                                       styleClass="#{searchBean.selectedService == service ? 'resultLink-selected' : ''}"
                                       onclick="_gaq.push(['_trackEvent', 'Database', '#{service.name}', '#{searchBean.userQuery.searchQuery}']);"
                                       disabled="#{not service.active
                                   or service.hits == 0
                                   or service.hits == -1
                                   or service.hits == -2
                                   or not service.checked}"
                                       style="#{searchBean.selectedService == service ? 'font-weight:bold; text-decoration: none; color: red' : ''}"
                                action="#{servicesTable.loadTableResults}" >

                            <f:setPropertyActionListener value="#{service}"
                                                         target="#{servicesTable.selectedService}"/>

                        </h:commandLink>
                        <tr:spacer width="2px"/>

                        <h:outputLink id="serviceURL_${status.index}"
                                      value="#{service.organizationUrl}" target="_blank">
                            <tr:image source="/images/external_link.gif"
                                      shortDesc="Organization URL"/>
                        </h:outputLink>
                        <tr:spacer width="2px"/>
                        <!--separator-->
                        <tr:outputText value="-" rendered="#{service.checked and service.active}"/>
                        <tr:spacer width="2px"/>
                        <tr:outputText id="resultCounts_${status.index}" value="#{service.hits}"
                                       rendered="#{service.hits ge 0 and service.checked and service.active}"
                                       inlineStyle="font-weight: bold;color: grey;">
                            <tr:convertNumber pattern="#,###"/>
                        </tr:outputText>
                        <tr:outputText value="Timed out"
                                       rendered="#{service.hits eq -1}"/>
                        <tr:outputText value="Error"
                                       rendered="#{service.hits eq -2}"/>

                        <tr:spacer width="5px"/>

                        <tr:spacer width="20px"/>

                    </tr:panelHorizontalLayout>
                </c:forEach>
            </tr:panelFormLayout>

            <tr:spacer height="16px"/>

        </td>
        <td style="vertical-align: middle; text-align: center">

            <!--Results selected-->
            <tr:panelFormLayout rows="4" maxColumns="1">
                <tr:group id="totalPanel">
                    <tr:outputText value="Interactions selected "/>
                    <tr:outputText id="totalResultsTable" value="#{servicesTable.selectedResults}">
                        <tr:convertNumber pattern="#,###"/>
                    </tr:outputText>
                </tr:group>

                <!--Cluster Button-->
                <tr:panelGroupLayout layout="vertical" inlineStyle="text-align: center;">

                    <tr:group>
                        <tr:commandLink action="dialog:help.clustering" partialSubmit="true"
                                        windowWidth="600" windowHeight="500" immediate="true"
                                        useWindow="true">
                            <tr:image source="/images/question.png" inlineStyle="vertical-align:text-bottom;"
                                      shortDesc="#{clusteringBean.clusterButtonHelpMessage}"/>
                        </tr:commandLink>
                        <tr:commandButton id="clusterButton"
                                          shortDesc="This button will be enabled with less than #{config.clusteringSizeLimit} interactions"
                                          action="#{clusteringBean.start}"
                                          disabled="#{servicesTable.selectedResults > config.clusteringSizeLimit or servicesTable.selectedResults le 0}"
                                          text="Cluster this query">

                        </tr:commandButton>
                    </tr:group>

                    <!--&lt;!&ndash;Download All Button&ndash;&gt;-->
                    <!--<tr:commandButton id="downloadAllButtonMain"-->
                                    <!--shortDesc="This button will be enabled with less than 3000000 interactions"-->
                                    <!--action="dialog:download.all"-->
                                    <!--useWindow="true"-->
                                    <!--windowWidth="600" windowHeight="500"-->
                                    <!--partialSubmit="true"-->
                                    <!--returnListener="#{downloadAllController.forward}"-->
                                    <!--disabled="#{servicesTable.selectedResults le 0 or servicesTable.selectedResults gt 3000000 or clusteringBean.clusterSelected}"-->
                                    <!--text="Download All"/>-->

                </tr:panelGroupLayout>

                <tr:spacer height="16px"/>

                <tr:panelGroupLayout>
                    <!-- Refresh the clustering status message every 5 secs when there are jobs to be displayed -->
                    <tr:panelGroupLayout partialTriggers="clusterButton">
                        <tr:panelGroupLayout rendered="#{not clusteringBean.clusterSelected and userClusteringJobs.jobCount gt 0}">
                            <tr:poll id="clusteringStatus" interval="5000"/>
                        </tr:panelGroupLayout>
                    </tr:panelGroupLayout>

                    <tr:panelBox id="jobListBox" text=" Status of your cluster queries" background="light"
                                 icon="/images/li.gif"
                                 rendered="#{userClusteringJobs.jobCount gt 0 and not clusteringBean.clusterSelected}"
                                 partialTriggers="clusteringStatus">

                        <tr:table value="#{userClusteringJobs.refreshedJobs}" var="job">
                            <tr:column>
                                <tr:outputText value="#{job.miql}" inlineStyle="text-overflow: ellipsis"/>
                            </tr:column>
                            <tr:column inlineStyle="white-space: nowrap;">
                                <tr:outputText value="#{job.status}" shortDesc="#{job.statusMessage}"/>
                            </tr:column>
                            <tr:column inlineStyle="white-space: nowrap;">
                                <tr:panelHorizontalLayout>
                                    <!-- View Job -->
                                    <tr:commandLink id="viewClick" action="#{clusteringBean.viewJob}" text="view"
                                                    rendered="#{job.status == 'COMPLETED'}">
                                        <f:param name="jobId" value="#{job.jobId}"/>
                                    </tr:commandLink>
                                    <tr:outputText value="view" rendered="#{job.status != 'COMPLETED'}"/>
                                    <tr:outputText value="&#160;|&#160;"/>
                                    <!-- Remove Job -->
                                    <tr:commandLink id="removeClick" action="#{clusteringBean.removeJob}" text="remove">
                                        <f:param name="jobId" value="#{job.jobId}" />
                                    </tr:commandLink>
                                </tr:panelHorizontalLayout>
                            </tr:column>
                        </tr:table>
                    </tr:panelBox>
                </tr:panelGroupLayout>

                <tr:panelGroupLayout>
                    <!-- Refresh the clustering status message every 5 secs when there are jobs to be displayed -->
                    <!--<tr:panelGroupLayout partialTriggers="downloadAllButtonMain">-->
                        <!--<tr:panelGroupLayout>-->
                            <!--<tr:poll id="downloadAllStatus" interval="5000"/>-->
                        <!--</tr:panelGroupLayout>-->
                    <!--</tr:panelGroupLayout>-->

                    <!--<tr:panelBox id="downloadListBox" text=" Status of your download queries" background="light"-->
                                 <!--icon="/images/li.gif"-->
                                 <!--partialTriggers="downloadAllStatus">-->
                        <!--<tr:outputText id="downloadText" value="#{downloadAllController.dir}" rendered="#{downloadAllController.absolutePath == null}"/>-->
                        <!--<tr:commandLink id="downloadTextClick" action="#{downloadAllController.clickDownload}" text="#{downloadAllController.dir}"-->
                                        <!--rendered="#{downloadAllController.absolutePath != null}">-->
                        <!--</tr:commandLink>-->
                      <!--</tr:panelBox>-->
                </tr:panelGroupLayout>

            </tr:panelFormLayout>
        </td>
    </tr>
</table>

</tr:panelGroupLayout>

<tr:panelGroupLayout rendered="#{searchBean.totalResults gt 0 and clusteringBean.clusterSelected}">

    <tr:separator/>
    <tr:panelGroupLayout id="clusterTable">
        <tr:outputText value="#{searchBean.selectedService.name}" inlineStyle="font-weight:bold; font-size:16px"/>
        <tr:separator/>
        <tr:panelGroupLayout layout="horizontal" id="clusterTable_${searchBean.totalResults}"
                             partialTriggers="clusterTable">
            <tr:group>
                <tr:outputText id="clusterResultsMsg" value="The query "/>
                <tr:outputText value="[#{userQuery.searchQuery}]" inlineStyle="font-weight: bold;"/>
                <tr:outputText value=" contains a total of "/>
                <tr:outputText id="clusterTotalResults" value="#{searchBean.totalResults}"
                               inlineStyle="font-weight: bold;">
                    <tr:convertNumber pattern="#,###"/>
                </tr:outputText>
                <tr:outputText
                        value="#{clusteringBean.clusterSelected ? ' clustered' : ' '} binary interactions."/>
            </tr:group>

            <tr:group>
                <table>
                    <tr>
                        <td style="vertical-align: middle"><tr:image source="/images/back_arrow.gif"/></td>
                        <td style="vertical-align: middle"><tr:commandLink action="#{clusteringBean.unselectClusterJob}"
                                                           text="Back to all services"/>
                        </td>
                    </tr>
                </table>
            </tr:group>

        </tr:panelGroupLayout>
        <tr:separator/>

        <ui:include src="tabs/tabs.xhtml">
            <ui:param name="service" value="${searchBean.selectedService}"/>
        </ui:include>

    </tr:panelGroupLayout>

</tr:panelGroupLayout>


<c:forEach var="service" items="${servicesTable.services}" varStatus="forStatus">
    <tr:panelGroupLayout id="serviceTable_${forStatus.index}" rendered="#{searchBean.selectedService == service}"
                         partialTriggers="servicesTable">
        <tr:outputText value="#{service.name}" inlineStyle="font-weight:bold; font-size:16px"/>
        <tr:separator/>
        <ui:include src="tabs/tabs.xhtml">
            <ui:param name="service" value="${searchBean.selectedService}"/>
        </ui:include>
    </tr:panelGroupLayout>
</c:forEach>

</tr:panelGroupLayout>

</tr:form>
</ui:composition>
