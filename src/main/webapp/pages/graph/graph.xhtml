<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:tr="http://myfaces.apache.org/trinidad"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://intact.ebi.ac.uk/miscel /WEB-INF/intact-miscel.tld">

    <!-- TODO enhance the handling of the graph div size on screen resize -->
    <!-- TODO Add on node click, a panel shows the details of a node, edge -->
    <!-- TODO On right click on a node, allow to expand the network by updating the MIQL query (Q OR node.id) -->
    <!-- TODO Add a way to run a text search by molecule name that highlights nodes -->
    <!-- TODO Add a way to color highlight publications, detection methods, species -->
    <!-- TODO Add a way to filter by confidence score with slider -->
    <!-- TODO Add a way to filter nodes by count of neighbour -->
    <!-- TODO Add a way to visualize graphicaly score or count of evidences -->
    <!-- TODO Add a way to represent spoke expanded interactions (better wait MITAB 2.6) -->
    <!-- TODO Need a URL to open the application on the graph tab, arams: serviceName, tab[graph/table]-->

    <div id="rightPanel" style="float:right; width:19%;">
        <div id="graphController" >
            <tr:panelBox text="CytoscapeWeb Controls" inlineStyle="width:98%;">

                <tr:panelHorizontalLayout>
                    <tr:outputText value="Layouts:" />&#160;
                    <tr:goLink destination="#" onclick="selectForceDirectedLayout();"><tr:outputText id="forceDirectedLayout" value="force directed" inlineStyle="font-weight:bold"/></tr:goLink>
                    &#160;|&#160;
                    <tr:goLink destination="#" onclick="selectRadialLayout();"><tr:outputText id="radialLayout" value="radial" inlineStyle="font-weight:normal"/></tr:goLink>
                    &#160;|&#160;
                    <tr:goLink destination="#" onclick="selectCircleLayout();"><tr:outputText id="circleLayout" value="circle" inlineStyle="font-weight:normal"/></tr:goLink>
                </tr:panelHorizontalLayout>

                <tr:panelHorizontalLayout>
                    <tr:outputText value="Merge edges:" />&#160;
                    <tr:goLink destination="#" onclick="selectMerged();"><tr:outputText id="mergeOn" value="on" inlineStyle="font-weight:bold"/></tr:goLink>
                    &#160;|&#160;
                    <tr:goLink destination="#" onclick="unselectMerged();"><tr:outputText id="mergeOff" value="off" inlineStyle="font-weight:normal"/></tr:goLink>
                </tr:panelHorizontalLayout>

                <!--<tr:panelHorizontalLayout>-->
                    <!--<tr:outputText value="Highlight:" />&#160;-->
                    <!--<tr:goLink destination="#" onclick="highlightSpecies( vis );"><tr:outputText id="species" value="species" inlineStyle="font-weight:normal"/></tr:goLink>-->
                <!--</tr:panelHorizontalLayout>-->

                <!--<tr:panelHorizontalLayout>-->
                    <!--<tr:outputText value="Download:" />&#160;-->
                    <!--<tr:goLink destination="#" onclick="vis.exportNetwork('xgmml', 'export.php?type=xml');"><tr:outputText id="xgmll" value="xgmll" inlineStyle="font-weight:normal"/></tr:goLink>-->
                    <!--&#160;|&#160;-->
                    <!--<tr:goLink destination="#" onclick="vis.exportNetwork('graphml', 'export.php?type=graphml');"><tr:outputText id="graphml" value="graphml" inlineStyle="font-weight:normal"/></tr:goLink>-->
                    <!--&#160;|&#160;-->
                    <!--<tr:goLink destination="#" onclick="vis.exportNetwork('sif', 'export.php?type=sif');"><tr:outputText id="sif" value="sif" inlineStyle="font-weight:normal"/></tr:goLink>-->
                    <!--&#160;|&#160;-->
                <!--</tr:panelHorizontalLayout>-->

            </tr:panelBox>
        </div>

        <div id="note" style="position:absolute;">
        </div>
    </div>

    <div id="cytoscapeweb" style="width:80%; height:900px; border:1px solid #d3d3d3;">
        Interaction Graph should show here in a few moment...
    </div>

    <script type="text/javascript">

        // network data could alternatively be grabbed via ajax
        var xmlUrl ='#{searchBean.applicationUrl}/graphmlDownload?mitabUrl=#{searchBean.mitabUrl}';


        // wait for the data to be loaded prior, handy for larger network.
        var xml = $.ajax({ url: xmlUrl, async: false }).responseText;

        // whether the edges should be merged or not
        var merged = true;

        // init and draw
        var vis = new org.cytoscapeweb.Visualization("cytoscapeweb");

        // callback when Cytoscape Web has finished drawing
        vis.ready(function() {

            vis.edgesMerged( merged );

            vis.addContextMenuItem("Select first neighbours", "nodes",
                                  function (evt) {
                                      // Get the right-clicked node:
                                      var rootNode = evt.target;

                                      // Get the first neighbors of that node:
                                      var fNeighbors = vis.firstNeighbors([rootNode]);
                                      var neighborNodes = fNeighbors.neighbors;

                                      // Select the root node and its neighbors:
                                      vis.select([rootNode]).select(neighborNodes);
                                  }
                    );

            // TODO in the node right click, link out to the service database using that molecule id
            // TODO edge > right click, link out to the service database using that interaction AC.

//            vis.addContextMenuItem("Link out to source web site", "nodes",
//                                  function (evt) {
//                                      // Get the right-clicked node:
//                                      var target = evt.target;
//
//                                      var identifier = target.data[ 'identifier' ];
//
//                                      // get url template
//                                      var url='http://www.google.com/q=${ac}}';
//
//                                      // open URL for that molecule
//                                      window.open(url.replace('${ac}}',identifier),'_blank',null);
//                                  }
//                    );

            vis.addContextMenuItem("Expand network around this molecule", "nodes",
                                  function (evt) {
                                      // Get the right-clicked node:
                                      var target = evt.target;

                                      var crossRef = target.data['identifier'].split('#');
                                      var identifier = crossRef[1];

                                      // update the search field
                                      var searchQuery = document.getElementById('queryTxt').value;
                                      var newQuery = '('+searchQuery+') OR id:' + identifier;
                                      document.getElementById('queryTxt').value = newQuery;

                                      // submit search
                                      document.mainForm.quickSearchBtn.click();
                                  }
                    );

            // add a listener for when nodes and edges are clicked
            vis.addListener("click", "nodes", function(event) {
                handle_node_click(event);
            });

            vis.addListener("click", "edges", function(event) {
                clear();
                handle_edge_click(event);
            });

            function handle_edge_click(event) {
                var target = event.target;

                clear();
                // print stuff here (eg. method, type, pmid, author, confidence value...).
            }

            function handle_node_click(event) {
                var target = event.target;

                clear();
                print( '<p><b><u>Node Properties</u></b></p>' );

                print( '<b>Molecule type</b>: ' + target.data['type']  + '<br/>');
                print( '<b>Interactor</b>: ' + target.data['label'] + '<br/>' );
                var species = target.data['specie'];
                if( species != null ) {
                    print( '<b>Species</b>: ' + species + '<br/>');
                }

                var crossRef = target.data['identifier'].split('#');
                var link = null;
                var db = crossRef[0];
                if( db == 'uniprotkb' ) {
                    link = 'http://www.uniprot.org/uniprot/' + crossRef[1];
                } else if( db == 'chebi' ) {
                    link = 'http://www.ebi.ac.uk/chebi/searchId.do?chebiId=' + crossRef[1];
                }
                print( '<b>Identifier</b>: ' );
                if( link != null) {
                    print( '<a href="' + link + '" target="_blank">' + crossRef[1] + '</a>' );
                } else {
                    print( crossRef[1] + ' ('+ crossRef[0] +')'  + '<br/>')
                }
            }

            function clear() {
                document.getElementById("note").innerHTML = "";
            }

            function print(msg) {
                document.getElementById("note").innerHTML += msg;
            }
        });


        // Enables the shapes present in the GraphML input to be displayed in the Flash panel.
        var style = {
            nodes: {
                shape: { passthroughMapper: { attrName: "shape" } }
            }
        };

        var draw_options = {
            // set visual style
            visualStyle: style,

            // your data goes here
            network: xml
        };

        vis.draw(draw_options);

        graphResize()

        showhide('cytoscapeweb');
        showhide('graphController');
    </script>

</ui:composition>
