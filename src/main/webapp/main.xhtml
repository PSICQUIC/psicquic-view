<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:tr="http://myfaces.apache.org/trinidad"
                xmlns:trh="http://myfaces.apache.org/trinidad/html"
                xmlns:c="http://java.sun.com/jstl/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:ebi="http://ebi.ac.uk/faces/components"
                xmlns:ebisf="http://www.ebi.ac.uk/faces/site">

  <tr:document title="${config.title}">

         <trh:head>

            <meta http-equiv="Content-Type"
                  content="text/html; charset=UTF-8"/>


            <!-- IntAct dynamic application should not be indexed by search engines -->
            <meta name='robots' content='nofollow'/>

            <link rel="stylesheet" href="#{ebisf:absoluteEbiUrl()}/inc/css/contents.css" type="text/css"/>
            <link rel="stylesheet" href="#{ebisf:absoluteEbiUrl()}/inc/css/userstyles.css" type="text/css"/>
            <link rel="stylesheet" href="#{ebisf:absoluteEbiUrl()}/inc/css/sidebars.css" type="text/css"/>
            <link rel="stylesheet" href="#{requestConfigBean.absoluteContextPath}/skins/ebi/ebi.css" type="text/css"/>

            <trh:script source="#{ebisf:absoluteEbiUrl()}/inc/js/contents.js" type="text/javascript"/>

             <trh:script source="/js/intact.js"/>

             <script type="text/javascript">
                 var _gaq = _gaq || [];
                 _gaq.push(['_setAccount', 'UA-672146-7']);
                 _gaq.push(['_trackPageview']);

                 (function() {
                     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                 })();

             </script>

         </trh:head>
      
      <c:set var="defaultBackImage" value="background-image: url('#{ebisf:absoluteContextPath()}/images/top_background.jpg')"/>
      <c:set var="userBackImage" value="background-image: url('#{config.bannerBackgroundUrl}')"/>
      <c:set var="backImage" value="#{empty config.bannerBackgroundUrl ? defaultBackImage : userBackImage}; background-repeat: repeat-x"/>

      <trh:body>
          <trh:tableLayout width="100%" inlineStyle="#{backImage}">
               <trh:rowLayout>
                   <trh:cellFormat inlineStyle="width:2%" >
                       <tr:image source="#{config.logoUrl}" rendered="#{not empty config.logoUrl}"/>
                   </trh:cellFormat>
                   <trh:cellFormat inlineStyle="vertical-align: bottom" rendered="#{not empty config.title}">
                       <h1><tr:outputFormatted value="&#160;#{config.title}"/></h1>
                   </trh:cellFormat>
               </trh:rowLayout>
           </trh:tableLayout>

          <div style="padding-left:10px; padding-right: 10px">

          <tr:form>

           <!-- To avoid expired sessions, poll every 15 mins -->
           <tr:poll interval="#{15*60*1000}"/>

           <tr:statusIndicator id="status">
               <f:facet name="busy">
                   <tr:panelGroupLayout layout="horizontal">
                       <tr:image source="/skins/ebi/images/status_busy_redback.gif"
                                 inlineStyle="vertical-align:middle"/>
                       <tr:outputFormatted value="&#160;"/>
                       <tr:outputText value="Loading..."/>
                   </tr:panelGroupLayout>
               </f:facet>
           </tr:statusIndicator>

           <ui:include src="/pages/search/search_panel.xhtml" />

           <div style="text-align:right; width:100%; margin-top: -20px; position:absolute;">
               <trh:tableLayout width="98%">
                   <trh:rowLayout>
                       <trh:cellFormat inlineStyle="width:99%">
                           &#160;
                       </trh:cellFormat>
                       <trh:cellFormat inlineStyle="background-color: white; text-align:right; white-space:nowrap; "
                               rendered="#{searchBean.totalResults gt 0}">
                           Total: <b>
                   <h:outputText value="#{searchBean.totalResults}" style="background-color:white;">
                       <f:convertNumber pattern="#,###"/>
                   </h:outputText></b>
                   <tr:outputText value="#{searchBean.clusterSelected ? ' clustered' : ''} binary interactions" />
                       </trh:cellFormat>
                   </trh:rowLayout>
               </trh:tableLayout>
           </div>


           <tr:panelGroupLayout rendered="#{searchBean.totalResults == 0}">
               <div style="padding-left:10px">
                 <b>No results were found for this query.</b>
               </div>
           </tr:panelGroupLayout>

           <tr:panelGroupLayout rendered="#{searchBean.totalResults gt 0 and not searchBean.clusterSelected}">

               Click on the links below to display the results for each service
               &#160;(<tr:commandLink text="refresh" actionListener="#{searchBean.refresh}"/>)

               <tr:spacer height="4px"/>

               <tr:panelHorizontalLayout>

                   <div style="float:left; ">
                       <tr:panelFormLayout rows="#{config.serviceRows}" maxColumns="4" fieldWidth="200" >
                           <c:forEach var="name" items="#{searchBean.allServiceNames}">
                               <tr:panelHorizontalLayout>
                                   <h:graphicImage alt="Status" title="#{searchBean.servicesMap[name].active? 'Status: ONLINE' : 'Status: OFFLINE'}"
                                                   url="#{searchBean.servicesMap[name].active? '/images/status_online.png' : '/images/status_offline.png'}"/>
                                   <h:commandLink value="#{name}" styleClass="#{searchBean.selectedServiceName == name? 'resultLink-selected' : ''}"
                                                  disabled="#{not searchBean.servicesMap[name].active or searchBean.resultCountMap[name] == 0}"
                                                  style="#{searchBean.selectedServiceName == name? 'font-weight:bold; text-decoration: none' : ''}">
                                       <f:setPropertyActionListener value="#{name}" target="#{searchBean.selectedServiceName}"/>
                                       <ui:param name="service" value="#{searchBean.servicesMap[name]}"/>
                                   </h:commandLink>
                                   <h:panelGroup rendered="#{searchBean.resultCountMap[name] != null}">
                                       &#160;-&#160;
                                       <tr:outputText value="#{searchBean.resultCountMap[name]}" styleClass="resultCount">
                                           <tr:convertNumber pattern="#,###"/>
                                       </tr:outputText>
                                   </h:panelGroup>
                               </tr:panelHorizontalLayout>
                           </c:forEach>
                       </tr:panelFormLayout>
                   </div>

                   <div style="float:right; padding-left:50px; padding-right:10px">
                       <tr:panelFormLayout rows="2" maxColumns="1">
                           <h:panelGroup>
                               <!-- Refresh the clustering status message every 5 secs when there are jobs to be displayed -->
                               <!--<tr:panelGroupLayout partialTriggers="clusterButton">-->
                                   <tr:panelGroupLayout rendered="#{not searchBean.clusterSelected and userJobs.jobCount gt 0}">
                                       <tr:poll id="clusteringStatus" interval="5000" />
                                   </tr:panelGroupLayout>
                               <!--</tr:panelGroupLayout>-->

                               <tr:panelBox id="jobListBox" text=" Status of your cluster queries" background="blue"
                                            icon="/images/li.gif"
                                            rendered="#{userJobs.jobCount gt 0 and not searchBean.clusterSelected}"
                                            partialTriggers="clusteringStatus"> <!-- ,clusterButton -->

                                   <tr:table value="#{userJobs.refreshedJobs}" var="job">
                                        <tr:column inlineStyle="white-space: nowrap;">
                                             <tr:outputText value="#{job.miql}" />
                                        </tr:column>
                                        <tr:column inlineStyle="white-space: nowrap;">
                                             <tr:outputText value="#{job.status}" shortDesc="#{job.statusMessage}" />
                                        </tr:column>
                                        <tr:column inlineStyle="white-space: nowrap;">
                                            <tr:panelHorizontalLayout>
                                                <!-- View Job -->
                                                <tr:commandLink action="#{clusteringBean.viewJob}" text="view" rendered="#{job.status == 'COMPLETED'}">
                                                    <f:param name="jobId" value="#{job.jobId}"/>
                                                </tr:commandLink>
                                                <tr:outputText value="view" rendered="#{job.status != 'COMPLETED'}" />
                                                <tr:outputText value="&#160;|&#160;" />
                                                <!-- Remove Job -->
                                                <tr:commandLink action="#{clusteringBean.removeJob}" text="remove">
                                                    <f:param name="jobId" value="#{job.jobId}"/>
                                                </tr:commandLink>
                                            </tr:panelHorizontalLayout>
                                        </tr:column>
                                   </tr:table>
                               </tr:panelBox>
                           </h:panelGroup>

                           <tr:panelHorizontalLayout>
                               <tr:commandButton id="clusterButton"

                                                 action="#{clusteringBean.start}"
                                                 rendered="#{searchBean.totalResults > 0}"
                                                 disabled="#{searchBean.totalResults > config.clusteringSizeLimit}"
                                                 text="Cluster this query"/>   <!-- partialSubmit="true" -->

                               <tr:commandLink action="dialog:help.clustering" partialSubmit="true"
                                               windowWidth="600" windowHeight="500" immediate="true"
                                               useWindow="true">
                                   <tr:image source="/images/question.jpeg"
                                             shortDesc="#{ clusteringBean.clusterButtonHelpMessage}" />
                               </tr:commandLink>
                           </tr:panelHorizontalLayout>

                       </tr:panelFormLayout>

                   </div>

               </tr:panelHorizontalLayout>

               <tr:separator/>

            </tr:panelGroupLayout>

            <tr:panelGroupLayout rendered="#{searchBean.totalResults gt 0 and searchBean.clusterSelected}">
                <table>
                    <tr>
                        <td align="middle"><tr:image source="/images/back_arrow.gif" /></td>
                        <td align="middle"><tr:commandLink action="#{searchBean.unselectClusterJob}" text="Back to all services"/></td>
                    </tr>
                </table>
            </tr:panelGroupLayout>


            <tr:panelGroupLayout rendered="#{searchBean.selectedServiceName != null}">
              <strong>#{searchBean.selectedServiceName}</strong>
              <ui:include src="/pages/interactions/interactions_tab.xhtml">
                  <ui:param name="service" value="#{searchBean.servicesMap[searchBean.selectedServiceName]}"/>
                  <ui:param name="results" value="#{searchBean.resultDataModelMap[searchBean.selectedServiceName]}"/>
              </ui:include>
            </tr:panelGroupLayout>

            <tr:panelGroupLayout rendered="#{searchBean.totalResults == 0}">
                <tr:separator/>

                   <div style="padding-left:10px">
                       It searches these databases: <b>#{searchBean.activeServicesName}</b>
                       <br/>
                       There are some inactive services at the moment: <b>#{searchBean.inactiveServicesName}</b>. (
                       <tr:goLink text="check status" destination="http://www.ebi.ac.uk/Tools/webservices/psicquic/registry/registry?action=STATUS"
                               targetFrame="_blank"/> |&#160;<tr:commandLink text="refresh" actionListener="#{searchBean.refresh}"/>)
                   </div>

                <tr:separator/>
           </tr:panelGroupLayout>

       </tr:form>
          </div>
      </trh:body>
   </tr:document>

</ui:composition>
