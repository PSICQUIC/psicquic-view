<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:tr="http://myfaces.apache.org/trinidad"
                xmlns:trh="http://myfaces.apache.org/trinidad/html"
                xmlns:c="http://java.sun.com/jstl/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:ebi="http://ebi.ac.uk/faces/components"
                xmlns:ebisf="http://www.ebi.ac.uk/faces/site">

<tr:document title="#{config.title}">

<trh:head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>


    <!--<link rel="stylesheet" href="http://wwwdev.ebi.ac.uk/frontier/template-service/resources/css/boilerplate-style.css" />-->
    <!--<link rel="stylesheet" href="http://wwwdev.ebi.ac.uk/frontier/template-service/resources/css/ebi-global.css" type="text/css" media="screen" />-->
    <!--<link rel="stylesheet" href="http://wwwdev.ebi.ac.uk/frontier/template-service/resources/css/ebi-visual.css" type="text/css" media="screen" />-->
    <!--<link rel="stylesheet" href="http://wwwdev.ebi.ac.uk/frontier/template-service/resources/css/984-24-col-fixed.css" type="text/css" media="screen" />-->

    <!-- IntAct dynamic application should not be indexed by search engines -->
    <meta name='robots' content='nofollow'/>

    <link rel="stylesheet" href="#{ebisf:absoluteEbiUrl()}/inc/css/contents.css" type="text/css"/>
    <link rel="stylesheet" href="#{ebisf:absoluteEbiUrl()}/inc/css/userstyles.css" type="text/css"/>
    <link rel="stylesheet" href="#{ebisf:absoluteEbiUrl()}/inc/css/sidebars.css" type="text/css"/>
    <link rel="stylesheet" href="#{requestConfigBean.absoluteContextPath}/skins/ebi/ebi.css" type="text/css"/>

    <trh:script source="#{ebisf:absoluteEbiUrl()}/inc/js/contents.js"/>

    <trh:script source="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"/>
    <trh:script source="/js/intact.js"/>


    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-672146-7']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>

</trh:head>

<c:set var="defaultBackImage"
       value="background-image: url('#{ebisf:absoluteContextPath()}/images/top_background.jpg')"/>
<c:set var="userBackImage" value="background-image: url('#{config.bannerBackgroundUrl}')"/>
<c:set var="backImage"
       value="#{empty config.bannerBackgroundUrl ? defaultBackImage : userBackImage}; background-repeat: repeat-x"/>

<trh:body>

<!--<script type="text/javascript">-->
<!--var mainHeaderUrl = '#{facesContext.externalContext.requestContextPath}/appMainHeader';-->
<!--jQuery.ajax({-->
<!--url:mainHeaderUrl,-->
<!--success:function (html) {-->
<!--var element = document.getElementById("global-masthead-container");-->
<!--$(element).empty();-->
<!--$(element).append(html);-->
<!--},-->
<!--error:function () {-->
<!--var element = document.getElementById("global-masthead-container");-->
<!--$(element).empty();-->
<!--$(element).append("An error occurred while loading the main header");-->
<!--}});-->

<!--var specificHeaderUrl = '#{facesContext.externalContext.requestContextPath}/appHeaderSpecific';-->
<!--jQuery.ajax({-->
<!--url:specificHeaderUrl,-->
<!--success:function (html) {-->
<!--var element = document.getElementById("local-masthead-container");-->
<!--$(element).empty();-->
<!--$(element).append(html);-->
<!--},-->
<!--error:function () {-->
<!--var element = document.getElementById("local-masthead-container");-->
<!--$(element).empty();-->
<!--$(element).append("An error occurred while loading the specific header");-->
<!--}});-->

<!--var mainFooterUrl = "#{facesContext.externalContext.requestContextPath}/appMainFooter";-->
<!--jQuery.ajax({-->
<!--url:mainFooterUrl,-->
<!--success:function (html) {-->
<!--var element = document.getElementById("global-footer-container");-->
<!--$(element).empty();-->
<!--$(element).append(html);-->
<!--},-->
<!--error:function () {-->
<!--var element = document.getElementById("global-footer-container");-->
<!--$(element).empty();-->
<!--$(element).append("An error occurred while loading the specific footer");-->
<!--}});-->

<!--</script>-->

<!--<div id="wrapper" class="container_24">-->
<!--<header>-->
<!--<div id="global-masthead-container"></div>-->
<!--<div id="local-masthead-container"></div>-->
<!--</header>-->

<!--<div id="content" role="main" class="grid_24 clearfix">-->
<tr:form id="headerForm" inlineStyle="width: 100%">
<trh:tableLayout inlineStyle="#{backImage}" width="100%">
    <trh:rowLayout width="100%">
        <trh:cellFormat inlineStyle="width: 100px">
            <tr:commandLink id="titleLink"
                            onclick="queryTxt = document.getElementById('queryTxt'); queryTxt.value = ''; queryTxt.focus()"
                            action="#{searchBean.doNewBinarySearch}"
                    >
                <tr:image source="#{config.logoUrl}" rendered="#{not empty config.logoUrl}" inlineStyle="width: 100px"/>
            </tr:commandLink>
        </trh:cellFormat>
        <tr:spacer width="2px"/>
        <trh:cellFormat inlineStyle="vertical-align: bottom" rendered="#{not empty config.title}">
            <h1><tr:outputText value="#{config.title}"/></h1>
        </trh:cellFormat>
    </trh:rowLayout>
</trh:tableLayout>
</tr:form>

<tr:form id="mainForm" inlineStyle="width: 100%">

<tr:panelGroupLayout layout="vertical" inlineStyle="padding-left:10px; padding-right: 10px;">



<!-- To avoid expired sessions, poll every 15 mins -->
<tr:poll interval="#{15*60*1000}"/>

<tr:statusIndicator id="status">
    <f:facet name="busy">
        <tr:panelGroupLayout layout="horizontal">
            <tr:image source="/skins/ebi/images/status_busy_redback.gif"
                      inlineStyle="vertical-align:middle"/>
            <tr:outputFormatted value="&#160;"/>
            <tr:outputText value="Loading..."/>
        </tr:panelGroupLayout>
    </f:facet>
</tr:statusIndicator>

<ui:include src="/pages/search/search_panel.xhtml"/>

<tr:panelGroupLayout>
    <tr:messages id="errorMsg"/>
</tr:panelGroupLayout>

<tr:separator/>

<tr:panelGroupLayout rendered="#{not searchBean.clusterSelected}">

    <table style="width:100%; height: 200px">
        <tr>
            <td style="vertical-align: top;">
                <!--Services-->
                <tr:panelHorizontalLayout rendered="#{searchBean.totalResults == 0}">

                    <h:outputText style="color: red; font-weight: bold"
                                  value="No results were found for this query#{searchBean.selectedServicesCount lt fn:length(searchBean.activeServiceNames)? ' for the selected services' : ''}."
                                  rendered="#{searchBean.selectedServicesCount != 0}"/>
                    <h:outputText style="color: red; font-weight: bold"
                                  value="Select at least one service from the list below!"
                                  rendered="#{searchBean.selectedServicesCount == 0}"/>
                </tr:panelHorizontalLayout>

                <tr:panelHorizontalLayout rendered="#{searchBean.totalResults gt 0}">
                    <f:facet name="separator">
                        <tr:spacer width="4px"/>
                    </f:facet>
                    <tr:outputText
                            value="Click on the links below to display the results for each selected service "/>
                </tr:panelHorizontalLayout>

                <tr:spacer height="4px"/>

                <h:panelGroup>
                    <tr:outputText
                            value="Use the check boxes to include or excludes services from the search and cluster operations - Select: "/>
                    <h:commandLink value="All"
                                   onclick="psicquic_selectAll(#{fn:length(searchBean.allServiceNames)})"/>
                    <tr:outputText value=", "/>
                    <h:commandLink value="None"
                                   onclick="psicquic_selectNone(#{fn:length(searchBean.allServiceNames)})"/>
                </h:panelGroup>

                <tr:spacer height="16px"/>

                <tr:panelFormLayout id="servicesTable" rows="#{config.serviceRows}" maxColumns="4">
                    <c:forEach var="name" items="${searchBean.allServiceNames}" varStatus="status">
                        <tr:panelHorizontalLayout>

                            <h:graphicImage id="serviceStatusOn_${status.index}"
                                            alt="Status: ONLINE" title="Status: ONLINE"
                                            url="/images/greenLight.png"
                                            rendered="#{searchBean.servicesMap[name].active and not (searchBean.resultCountMap[name] lt '0')}"/>
                            <h:graphicImage id="serviceStatusOff_${status.index}"
                                            alt="Status: OFFLINE" title="Status: OFFLINE"
                                            url="/images/greyLight.png"
                                            rendered="#{not searchBean.servicesMap[name].active}"/>
                            <h:graphicImage id="serviceStatusWarn_${status.index}"
                                            alt="Status: WARNING"
                                            title="Status: WARNING - This service can not respond to the query"
                                            url="/images/orangeLight.png"
                                            rendered="#{searchBean.servicesMap[name].active and (searchBean.resultCountMap[name] == '-1')}"/>
                            <h:graphicImage id="serviceStatusErr_${status.index}"
                                            alt="Status: ERROR"
                                            title="Status: ERROR - This service has an unexpected error"
                                            url="/images/redLight.png"
                                            rendered="#{searchBean.servicesMap[name].active and (searchBean.resultCountMap[name] == '-2')}"/>


                            <h:selectBooleanCheckbox id="serviceSel_${status.index}"
                                                     value="#{searchBean.serviceSelectionMap[name]}"
                                                     disabled="#{not searchBean.servicesMap[name].active}"/>

                            <h:commandLink id="serviceLink_${status.index}" value="#{name}"
                                           styleClass="#{searchBean.selectedServiceName == name ? 'resultLink-selected' : ''}"
                                           onclick="_gaq.push(['_trackEvent', 'Database', '#{name}', '#{searchBean.userQuery.searchQuery}']);"
                                           disabled="#{not searchBean.servicesMap[name].active
                                                           or searchBean.resultCountMap[name] == 0
                                                           or searchBean.resultCountMap[name] == -2
                                                           or not searchBean.serviceSelectionMap[name]}"
                                           style="#{searchBean.selectedServiceName == name ? 'font-weight:bold; text-decoration: none' : ''}">
                                <f:setPropertyActionListener value="#{name}"
                                                             target="#{searchBean.selectedServiceName}"/>
                                <ui:param name="service" value="#{searchBean.servicesMap[name]}"/>
                            </h:commandLink>
                            <tr:spacer width="2px"/>

                            <h:outputLink id="serviceURL_${status.index}"
                                          value="#{searchBean.servicesMap[name].organizationUrl}" target="_blank">
                                <tr:image source="/images/external_link.gif"
                                          shortDesc="Organization URL"/>
                            </h:outputLink>
                            <tr:spacer width="2px"/>

                            <h:panelGroup id="resultsCounts" rendered="#{searchBean.resultCountMap[name] != null}">
                                &#160;-&#160;
                                <tr:outputText value="#{searchBean.resultCountMap[name]}" styleClass="resultCount"
                                               rendered="#{searchBean.resultCountMap[name] ge '0'}">
                                    <tr:convertNumber pattern="#,###"/>
                                </tr:outputText>
                                <tr:outputText value="Timed out" styleClass="resultCount"
                                               rendered="#{searchBean.resultCountMap[name] == '-1'}"/>
                                <tr:outputText value="Error" styleClass="resultCount"
                                               rendered="#{searchBean.resultCountMap[name] == '-2'}"/>
                            </h:panelGroup>
                            <tr:spacer width="5px"/>

                        </tr:panelHorizontalLayout>
                    </c:forEach>
                </tr:panelFormLayout>
            </td>
            <td style="vertical-align: middle; text-align: center">
                <!--Cluster Button-->
                <tr:panelFormLayout rows="2" maxColumns="1">
                    <tr:panelGroupLayout inlineStyle="height: 100%; width: 100% ;">
                        <tr:commandButton id="clusterButton"
                                          action="#{clusteringBean.start}"
                                          rendered="#{searchBean.totalResults > 0}"
                                          disabled="#{searchBean.totalResults > config.clusteringSizeLimit}"
                                          text="Cluster this query"/>   <!-- partialSubmit="true" -->

                        <tr:commandLink action="dialog:help.clustering" partialSubmit="true"
                                        rendered="#{searchBean.totalResults > 0}"
                                        windowWidth="600" windowHeight="500" immediate="true"
                                        useWindow="true">
                            <tr:image source="/images/question.jpeg" inlineStyle="vertical-align:middle;"
                                      shortDesc="#{clusteringBean.clusterButtonHelpMessage}"/>
                        </tr:commandLink>
                    </tr:panelGroupLayout>
                    <tr:panelGroupLayout>
                        <!-- Refresh the clustering status message every 5 secs when there are jobs to be displayed -->
                        <!--<tr:panelGroupLayout partialTriggers="clusterButton">-->
                        <tr:panelGroupLayout rendered="#{not searchBean.clusterSelected and userJobs.jobCount gt 0}">
                            <tr:poll id="clusteringStatus" interval="5000"/>
                        </tr:panelGroupLayout>
                        <!--</tr:panelGroupLayout>-->

                        <tr:panelBox id="jobListBox" text=" Status of your cluster queries" background="light"
                                     icon="/images/li.gif"
                                     rendered="#{userJobs.jobCount gt 0 and not searchBean.clusterSelected}"
                                     partialTriggers="clusteringStatus"> <!-- ,clusterButton -->

                            <tr:table value="#{userJobs.refreshedJobs}" var="job">
                                <tr:column inlineStyle="white-space: nowrap;">
                                    <tr:outputText value="#{job.miql}"/>
                                </tr:column>
                                <tr:column inlineStyle="white-space: nowrap;">
                                    <tr:outputText value="#{job.status}" shortDesc="#{job.statusMessage}"/>
                                </tr:column>
                                <tr:column inlineStyle="white-space: nowrap;">
                                    <tr:panelHorizontalLayout>
                                        <!-- View Job -->
                                        <tr:commandLink action="#{clusteringBean.viewJob}" text="view"
                                                        rendered="#{job.status == 'COMPLETED'}">
                                            <f:param name="jobId" value="#{job.jobId}"/>
                                        </tr:commandLink>
                                        <tr:outputText value="view" rendered="#{job.status != 'COMPLETED'}"/>
                                        <tr:outputText value="&#160;|&#160;"/>
                                        <!-- Remove Job -->
                                        <tr:commandLink action="#{clusteringBean.removeJob}" text="remove">
                                            <f:param name="jobId" value="#{job.jobId}"/>
                                        </tr:commandLink>
                                    </tr:panelHorizontalLayout>
                                </tr:column>
                            </tr:table>
                        </tr:panelBox>
                    </tr:panelGroupLayout>
                </tr:panelFormLayout>
            </td>
            <td style="text-align: right; vertical-align: top">
                <!--Legend and Total-->
                <table style="width:100%; height: 100%">
                    <tr>
                        <td align="right" style="vertical-align: top;">
                            <h:panelGroup>
                                <tr:outputText value="Total: "/>
                                <tr:outputText value="#{searchBean.totalResults} "
                                               inlineStyle="background-color:white; font-weight: bold; ">
                                    <f:convertNumber pattern="#,###"/>
                                </tr:outputText>
                                <tr:outputText
                                        value="#{searchBean.clusterSelected ? ' clustered' : ' '} binary interactions"/>
                            </h:panelGroup>
                        </td>
                    </tr>

                    <tr>
                        <td align="right" style="vertical-align: bottom;">
                            <tr:panelBox background="light" text="Status of the service">
                                <ui:include src="pages/search/legend.xhtml"/>
                            </tr:panelBox>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

</tr:panelGroupLayout>

<tr:panelGroupLayout rendered="#{searchBean.totalResults gt 0 and searchBean.clusterSelected}">
    <table>
        <tr>
            <td align="middle"><tr:image source="/images/back_arrow.gif"/></td>
            <td align="middle"><tr:commandLink action="#{searchBean.unselectClusterJob}"
                                               text="Back to all services"/>
            </td>
        </tr>
    </table>
</tr:panelGroupLayout>

<tr:separator/>


<c:forEach var="name" items="${searchBean.allServiceNames}" varStatus="forStatus">
    <tr:panelGroupLayout id="serviceTable_${forStatus.index}" rendered="#{searchBean.selectedServiceName == name}"
                         partialTriggers="servicesTable">
        <tr:outputText value="#{searchBean.selectedServiceName}" inlineStyle="font-weight:bold; font-size:16px"/>
        <tr:separator/>
        <ui:include src="pages/tabs/tabs.xhtml"/>
    </tr:panelGroupLayout>
</c:forEach>

<!--<tr:panelGroupLayout rendered="#{searchBean.totalResults == 0}">-->
<!--<tr:separator/>-->

<!--<div style="padding-left:10px">-->
<!--It searches these databases: <b>#{searchBean.activeServicesName}</b>-->
<!--<br/>-->
<!--There are some inactive services at the moment: <b>#{searchBean.inactiveServicesName}</b>. (-->
<!--<tr:goLink text="check status" destination="http://www.ebi.ac.uk/Tools/webservices/psicquic/registry/registry?action=STATUS"-->
<!--targetFrame="_blank"/> |&#160;<tr:commandLink text="refresh" actionListener="#{searchBean.refreshApp}"/>)-->
<!--</div>-->

<!--<tr:separator/>-->
<!--</tr:panelGroupLayout>-->

</tr:panelGroupLayout>

</tr:form>

<!--</div>-->
<!--<footer>-->
<!--<div id="global-footer-container"></div>-->
<!--</footer>-->
<!--</div>-->
</trh:body>
</tr:document>

</ui:composition>
